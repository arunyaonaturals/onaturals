// Prisma schema for Arunya ERP
// Using Turso (libsql) as database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// ==================== USERS ====================
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String
  role      String   @default("sales_captain") // admin, sales_captain
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  areas    Area[]    // Areas managed by this sales captain
  orders   Order[]   // Orders created by this user
  payments Payment[] // Payments collected by this user
}

// ==================== PRODUCTS ====================
model Category {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  products  Product[]
  createdAt DateTime  @default(now())
}

model Product {
  id           Int           @id @default(autoincrement())
  name         String
  sku          String?       @unique
  categoryId   Int?
  category     Category?     @relation(fields: [categoryId], references: [id])
  weight       Float?
  weightUnit   String?       @default("g") // g, kg, ml, l
  mrp          Float         @default(0)
  gstPercent   Float         @default(18)
  hsnCode      String?
  isActive     Boolean       @default(true)
  currentStock Float         @default(0)
  minStock     Float         @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  orderItems   OrderItem[]
  invoiceItems InvoiceItem[]
}

// ==================== STORES ====================
model Area {
  id             Int      @id @default(autoincrement())
  name           String   @unique
  salesCaptainId Int?
  salesCaptain   User?    @relation(fields: [salesCaptainId], references: [id])
  stores         Store[]
  createdAt      DateTime @default(now())
}

model Store {
  id                   Int       @id @default(autoincrement())
  name                 String
  address              String?
  city                 String?
  state                String?
  pincode              String?
  phone                String?
  email                String?
  gstNumber            String?
  contactPerson        String?
  areaId               Int?
  area                 Area?     @relation(fields: [areaId], references: [id])
  marginDiscountPercent Float?   // Default discount % for this store (e.g. 5 = 5%), applied when creating invoice
  isActive             Boolean   @default(true)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  orders               Order[]
  invoices             Invoice[]
  payments             Payment[]
}

// ==================== ORDERS ====================
model Order {
  id          Int         @id @default(autoincrement())
  orderNumber String      @unique
  storeId     Int
  store       Store       @relation(fields: [storeId], references: [id])
  createdById Int
  createdBy   User        @relation(fields: [createdById], references: [id])
  status      String      @default("draft") // draft, submitted, approved, invoiced, cancelled
  notes       String?
  totalAmount Float       @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  items       OrderItem[]
  invoice     Invoice?
}

model OrderItem {
  id                 Int     @id @default(autoincrement())
  orderId            Int
  order              Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId          Int
  product            Product @relation(fields: [productId], references: [id])
  quantity           Int     @default(0) // New stock needed (order quantity)
  availableQuantity  Int?    // Available at store when sales captain recorded
  price              Float   @default(0) // Price at time of order
  total              Float   @default(0)
}

// ==================== INVOICES ====================
model Invoice {
  id            Int           @id @default(autoincrement())
  invoiceNumber String        @unique
  orderId       Int           @unique
  order         Order         @relation(fields: [orderId], references: [id])
  storeId       Int
  store         Store         @relation(fields: [storeId], references: [id])
  subtotal      Float         @default(0)
  discountPercent Float?      // Store margin discount % applied (e.g. 5)
  discountAmount   Float      @default(0)
  gstAmount     Float         @default(0)
  totalAmount   Float         @default(0)
  paidAmount    Float         @default(0)
  balanceAmount Float         @default(0)
  status        String        @default("unpaid") // unpaid, partial, paid
  dueDate       DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  items         InvoiceItem[]
  payments      Payment[]
}

model InvoiceItem {
  id         Int     @id @default(autoincrement())
  invoiceId  Int
  invoice    Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  productId  Int
  product    Product @relation(fields: [productId], references: [id])
  quantity   Int     @default(0)
  price      Float   @default(0) // Factor price after discount
  discountPercent Float?   @default(0)
  discountAmount  Float    @default(0)
  gstPercent Float   @default(18)
  gstAmount  Float   @default(0)
  total      Float   @default(0)
}

// ==================== PAYMENTS ====================
model Payment {
  id            Int      @id @default(autoincrement())
  paymentNumber String   @unique
  invoiceId     Int
  invoice       Invoice  @relation(fields: [invoiceId], references: [id])
  storeId       Int
  store         Store    @relation(fields: [storeId], references: [id])
  collectedById Int
  collectedBy   User     @relation(fields: [collectedById], references: [id])
  amount        Float    @default(0)
  paymentMode   String   @default("cash") // cash, upi, bank_transfer, cheque
  reference     String? // UPI ref, cheque number, etc.
  notes         String?
  collectedAt   DateTime @default(now())
  createdAt     DateTime @default(now())
}

// ==================== INVENTORY ====================
model RawMaterial {
  id           Int         @id @default(autoincrement())
  name         String
  unit         String      @default("kg") // kg, g, l, ml, pcs
  currentStock Float       @default(0)
  minStock     Float       @default(0)
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  movements    Inventory[]
}

model Inventory {
  id            Int         @id @default(autoincrement())
  rawMaterialId Int
  rawMaterial   RawMaterial @relation(fields: [rawMaterialId], references: [id])
  type          String // in, out, adjustment
  quantity      Float       @default(0)
  notes         String?
  createdAt     DateTime    @default(now())
}

// ==================== PRODUCTION ====================
model Production {
  id          Int      @id @default(autoincrement())
  productName String
  quantity    Int      @default(0)
  status      String   @default("suggested") // suggested, in_progress, completed
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
